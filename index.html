<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Private Chat</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; }
        #messages { width: 90%; max-width: 600px; flex-grow: 1; overflow-y: auto; background: white; margin: 20px 0; padding: 15px; border-radius: 10px; }
        .input-area { width: 90%; max-width: 600px; display: flex; gap: 10px; padding-bottom: 20px; }
        input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="messages"></div>
    <div class="input-area">
        <input type="text" id="msg" placeholder="メッセージを入力...">
        <button id="send">送信</button>
    </div>
    <button onclick="localStorage.clear(); location.href='login.html'" style="background:#ccc; margin-bottom:10px;">ログアウト</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2P66lPG8WyMNlx3AKHNxI023s0Xg_Vs8",
            authDomain: "my-chat-app-e20e2.firebaseapp.com",
            databaseURL: "https://my-chat-app-e20e2-default-rtdb.firebaseio.com",
            projectId: "my-chat-app-e20e2",
            storageBucket: "my-chat-app-e20e2.firebasestorage.app",
            messagingSenderId: "694675475344",
            appId: "1:694675475344:web:ed3ff496775f7d7dd30115"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const dbRef = ref(db, "chat");

        // ログインチェック：ログインしてなければ login.html へ
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            }
        });

        document.getElementById("send").onclick = () => {
            const text = document.getElementById("msg").value;
            if(!text) return;
            push(dbRef, { uname: auth.currentUser.email.split('@')[0], text: text, time: serverTimestamp() });
            document.getElementById("msg").value = "";
        };

        onChildAdded(dbRef, (data) => {
            const m = data.val();
            document.getElementById("messages").insertAdjacentHTML("beforeend", `<div><b>${m.uname}</b>: ${m.text}</div>`);
            document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
        });
    </script>
</body>
</html>
